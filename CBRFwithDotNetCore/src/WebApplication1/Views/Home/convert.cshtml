@*
    For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
<html>
<head>
    <title>Конвертирование</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#valute').change(function () {
                //var _per = $(periods).find('option:selected').val();
                if ($(this).val() == 0) return false;
                var _vals = $(valute).find('option:selected').val();
                var target = $("#valuteRows");
                var selector = $("#valute");
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("AddToConvert", "Convert")",
                    data: {
                        "name": _vals
                    },
                    async: false,
                    success: function (data) {
                        var json = $.parseJSON(data);
                        selector.empty();
                        selector.append("<option value=\"0\">---Выберите валюту---</option>");
                        for (var i = 0; i < json.length; ++i) {
                            selector.append("<option>" + json[i].name + "</option>");
                        }
                        target.append("<tr><td><b class=\"col1\">" + _vals + "</b></td><td> <input type=\"text\" name='" + _vals + "' class='txtCal'> </td> <td><span class='spnRemove'><input type=\"button\"  class='valCal' name='" + _vals + "' value=\"X\"></span></td></tr>");
                    },
                    dataType: 'html',
                    error: function (data) {
                        alert("Ошибка при запросе на добавление валюты:" + data);
                    }
                });
            });
        });
    </script>

    <script type="text/javascript">
        $(document).ready(function () {
            $('#calculate').click(function () {
                var _valutes = [];
                var _numbers = [];
                var _number = 0;
                var _incorrect = 0;
                var _outval = $(outvalute).find('option:selected').val();
                $("#valuteRows .valCal").each(function () {
                    var get_value = $(this).attr("name");
                    _valutes.push(get_value);
                });
                $("#valuteRows .txtCal").each(function () {
                    var get_textbox_value = $(this).val();
                    //Валидация
                    if (isNaN(get_textbox_value)) {
                        alert("Проверьте поле '" + _valutes[_number] + "'");
                        _incorrect++;;
                    } else {
                        if (parseFloat(get_textbox_value) < 0) {
                            alert("В поле '" + _valutes[_number] + "' введено отрицательное значение");
                            _incorrect++;
                        }
                        
                    }
                    _number++;
                    _numbers.push(get_textbox_value);
                });
                if (_incorrect == 0) {
                    $.ajax({
                        type: "POST",
                        url: "@Url.Action("TryCount", "Convert")",
                        data: {
                            "_valList": _valutes,
                            "_numList": _numbers,
                            "_exitval": _outval
                        },
                        async: false,
                        success: function (data) {
                            var json = $.parseJSON(data);
                            var selector = $("#result");
                            selector.empty();
                            if (json.failVal == 'ok') {
                            }
                            else {
                                alert("Ошибка при вычислении: " + json.failVal);
                                return false;
                            }
                            selector.append("<b> Итого: <i>" + json.counted + "</i></b>");
                        },
                        dataType: 'html',
                        error: function (data) {
                            alert("Ошибка при запросе на подсчёт. Проверьте, что все ячейки заполнены.");
                        }
                    });
                }
                else {
                    var selector = $("#result");
                    selector.empty();
                    selector.append("<b><i>Некорректные данные</i></b>");
                }
            });
        });
    </script>

    @*@*нажатие на кнопки удаления*@
    <script type="text/javascript">
        $(document).ready(function () {
            $("#results").on('click', '.spnRemove', function () {
                var self = $(this).closest("tr");
                var _name = self.find(".col1").text();
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("RemoveFromConvert", "Convert")",
                    data: {
                        "name": _name
                    },
                    async: false,
                    success: function (data) {
                        var selector = $("#valute");
                        var json = $.parseJSON(data);
                        selector.empty();
                        selector.append("<option value=\"0\">---Выберите валюту---</option>");
                        for (var i = 0; i < json.length; ++i) {
                            selector.append("<option>" + json[i].name + "</option>");
                        }
                        self.remove();
                    },
                    dataType: 'html',
                    error: function (data) {
                        alert("Ошибка при запросе на удаление:" + data);
                    }
                });
            });
        });
    </script>

    <style>
        .design {
            display: inline-block; /* Строчно-блочный элемент */
            padding: 5px 20px; /* Добавляем поля */
            text-decoration: none; /* Убираем подчёркивание у ссылки */
            cursor: pointer; /* Курсор в виде руки */
            border-radius: 10px; /* Скругляем уголки */
            border: 1px solid #008; /* Добавляем синюю рамку */
            font: 12px/1 Arial, sans-serif; /* Рубленый шрифт */
            color: #B6B8DB; /* Цвет текста и ссылки */
        }

        .selected {
            display: inline-block; /* Строчно-блочный элемент */
            padding: 5px 20px; /* Добавляем поля */
            text-decoration: none; /* Убираем подчёркивание у ссылки */
            cursor: pointer; /* Курсор в виде руки */
            border-radius: 10px; /* Скругляем уголки */
            border: 1px solid #008; /* Добавляем синюю рамку */
            font: 12px/1 Arial, sans-serif; /* Рубленый шрифт */
            color: #E5367B; /* Цвет текста и ссылки */
        }
    </style>
    <style>
        body {
            background: #1E223B;
            color: #ffffff;
        }

        hr {
            border: none;
            color: #292F4E;
            background-color: #292F4E;
            height: 1px;
        }
    </style>

</head>

<body>
    <center>
        <hr>
        <a href="/Home/Index/" class="design">Начальная страница</a>
        <a href="/Home/Dynamic/" class="design">График</a>
        <a href="/Home/Convert/" class="selected">Конвертер</a>
        <a href="/Home/Settings/" class="design">Настройки</a>
        <hr>
    </center>

    <h3>Имеющиеся валюты</h3>
    <p>Перевести в валюту:</p>
    <select id="outvalute" name="outValSelection">
        <option>Российский рубль</option>
        @foreach (string val in (List<string>)ViewBag.SelectList)
        {
            <option>@val</option>
        }
    </select>
    <p>Добавить валюту</p>
    <select id="valute" name="valSelection">
        <option value="0">---Выберите валюту---</option>
        @foreach (string val in (List<string>)ViewBag.SelectList)
        {
            <option>@val</option>
        }
    </select>
    <div id="results">
        <table id="valuteRows"></table>
    </div>

    <br />
    <input type="button" value="Вычислить" id="calculate">
    <br />
    <label><span id="result" class="result"></span></label>

</body>

</html>
